/**
 * Created by mark on 11/12/2015.
 */

module.exports = function (app, fs) {
    app.post('/api/getProduct',function (req, res) {
        try {
            var query = productsSchema.find({
                slug : req.body.slug,
                lang : req.body.lang
            }).exec(function (err, docs) {
                if (!err) {
                    if(docs.length == 1) {
                        res.send({error : false, data : docs[0], message : "success"}).end();
                    }
                    else {
                        res.send({error : true, message : "product-error", code : "pe1"}).end();
                    }
                }
                else {
                    console.log('error');
                }
            })
        }
        catch (err) {
            console.error(err);
        }
    });
    //app.post('*', function (req, res) {
    //    res.sendFile('index.html', { root: '././files/' });
    //});
    //app.get('*', function (req, res) {
    //    res.sendFile('index.html', { root: '././files/' });
    //});
    app.get('*', function (req, res) {
        var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
        console.log('agent - ' + userAgent);
        if (userAgent != 'Googlebot' && userAgent != 'bingbot' && userAgent != 'Slurp' && userAgent != 'FacebookBot') {
            res.sendFile('index.html', { root: '././files/' });
        }
        else {
            console.log('bot - ' + userAgent);
            //exports.botHack(req, res); req._parsedOriginalUrl.pathname == '/' &&
        }
    });

    app.post('*', function (req, res) {
        var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
        console.log('agent - ' + userAgent);
        if (userAgent != 'Googlebot' && userAgent != 'bingbot' && userAgent != 'Slurp' && userAgent != 'FacebookBot') {
            res.sendFile('index.html', { root: '././files/' });
        }
        else {
            console.log('bot - ' + userAgent);
            //exports.botHack(req, res); req._parsedOriginalUrl.pathname == '/' &&
        }
    });
};

exports.botHack = function (req, res) {

}

//exports.botHack = function (req, res) {
//    var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
//    try {
//        if (userAgent != 'Googlebot' && userAgent != 'bingbot' && userAgent != 'Slurp' && userAgent != 'FacebookBot'  && userAgent != 'GooglePlusBot') {
//            backStage.setRedierect(req, res);
//            return;
//        }
//        if (req.url == '/') {
//            req.route.path = 'main';
//            backStage.botRequests(req, res);
//        }
//        else if (req.url.indexOf('movie') > -1) {
//            var movieId = req.url.replace(/^\D+/g, '');
//            req.body = {fields: 'cover,title,synopsis,keywords,persons', no_geo: 'true'}
//            req.route.path = '/api/single_film';
//            req.body.reqID = movieId;
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('person') > -1) {
//            var personId = req.url.replace(/^\D+/g, '');
//            req.body = {fields: 'cover,title,brief,filmography', no_geo: 'true'}
//            req.route.path = '/api/person';
//            req.body.reqID = personId;
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('all') > -1) {
//            req.route.path = 'all';
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('about-us') > -1) {
//            req.route.path = 'about-us';
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('termsofuse') > -1) {
//            req.route.path = 'termsofuse';
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('privacy') > -1) {
//            req.route.path = 'privacy';
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('signup') > -1) {
//            req.route.path = 'signup';
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('genre') > -1) {
//            var genre_id = req.url.replace(/^\D+/g, '');
//            req.body = {fields: 'cover,title,synopsis,filmography', no_geo: 'true'}
//            req.route.path = 'genre';
//            req.body.genre_id = genre_id;
//            backStage.botRequests(req, res);
//            return;
//        }
//        else if (req.url.indexOf('article') > -1) {
//            var news_slug = req.url.substr(req.url.indexOf("/article/") + 9);
//            var hostName = configs.getHostName(req.headers.host);
//            newsFeed.news.getArticle(news_slug, function(response){
//                if(response.error != true){
//                    console.log(response.data);
//                    response.data.description = response.data.description.replace(/<\/?[^>]+(>|$)/g, "");
//                    res.render('botView/news', {data: response.data, host: hostName, url:req.url}, function (err, html) {
//                        if (!err) {
//                            res.write(html);
//                            res.end();
//                            return;
//                        }
//                        console.error(err);
//                        return;
//                    });
//                }
//            });
//            return;
//        }
//        else {
//            req.route.path = 'main';
//            backStage.botRequests(req, res);
//        }
//
//    }
//    catch (e) {
//        console.log({'level': 'ERROR', 'message': e});
//    }
//}