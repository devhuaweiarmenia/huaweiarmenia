/**
 * Created by mark on 11/12/2015.
 */

module.exports = function (app, fs) {
    app.post('/api/getProducts',function (req, res) {
        var products = require('./products.json');
        var arr =[];
        for( var i in products ) {
            if (products.hasOwnProperty(i)){
                arr.push(products[i]);
            }
        }
        if(req.body.type == 's') {
            products = arr.filter(function(item){return item.type == 'smartphone'})
            res.send(products).end();
        }
        else if(req.body.type == 't') {
            products = arr.filter(function(item){return item.type == 'tablet'})
            res.send(products).end();
        }
    });
    app.post('/api/getProduct',function (req, res) {
        var path = './data/products/'+ req.body.lang + '-' + req.body.slug + '.json';
        fs.readFile(path, 'utf8', function (err, data) {
            if (err) {
                console.error(err);
                res.send({error : 'No such product.'});
            }
            else {
                var obj = JSON.parse(data);
                res.send(obj);
            }

        });
    });
    app.post('/api/getArticles',function (req, res) {
        var articles;
        switch(req.body.lang) {
            case 'en':
                articles = [
                    {
                        title: "Why It's Impossible not to Love Huawei : 11 Facts", text: "It's sure not easy to choose a smartphone or a gadget these days. Options are vast, criteria different. So it's not easy to cherry-pick and as a result you might end up with a device you bought simply because your friends have it. In order to understand the quality criteria one has to be familiar with industry leaders. Chinese company Huawei is one of the biggest smartphone manufacturers nowadays. A few years back this would have been hard to believe but today it's a stated fact. Last year the company introduced its new concept: «Make it Possible», and Huawei's new motto is «Dreams inspire creativity». Below are 11 facts about Huawei out of many that will change you perception of this Chinese company.", date: '11.08.2016', img: '1.png', slug: '11_facts_about_huawei'
                    },
                    {
                        title: "7 facts which will make you choose Huawei over Apple and Samsung.", text: "When choosing a smartphone we put most emphasis on the available budget and technical requirements. At first, it appears to be an easy choice but usually it's harder than it seems. What to choose? How to choose? In reality we make a choice after comparing the options. Do you want to make the right choice? Then lets take a look  on these 7 main comparison points which will help you with decission. ", date: '24.08.2016', img: '7_reasons_to_choose_huawei/7facts.jpg', slug: '7_reasons_to_choose_huawei'
                    }
                ];
                break;
            case 'ru':
                articles = [
                    {
                        title: "11 фактов которые вы незнали о Huawei", text: "Выбор смартфонов и другого оборудования на сегодняшний день является нелегкой задачей. Учитывая широкий ассортимент и различные критерии, можно легко запутаться, и при выборе руководствоваться не качеством, а лишь тем, что выбирают наши знакомые. Более того, необходимо знать лидеров данной отрасли для того, чтобы опеределить критерии оценки качества. Китайская компания Huawei является одним из крупнейших производителей смартфонов. Несколько лет назад в это было бы трудно поверить, но на сегодняшний день это является признанным фактом.", date: '11.08.2016', img: '1.png', slug: '11_facts_about_huawei'
                    },
                    {
                        title: "7 сравнений, после которых вы захотите выбрать Huawei вместо Apple или Samsung.", text: "Выбирая смартфон, мы руководствуемся наличием суммы, предназначенной для данной покупки, и нaшими представлениями о технике. На первый взгляд, это, казалось бы, простое решение, на самом деле, не всегда является таковым. Что выбрать? Как выбрать? В действительности, правильный выбор делается в результате сравнения. Желаете сделать правильный выбор?  Для сравнения и осуществления выбора посредстом данного сравнения, давайте ознакомимся со следующими 7 пунктами.", date: '24.08.2016', img: '7_reasons_to_choose_huawei/7facts.jpg', slug: '7_reasons_to_choose_huawei'
                    }
                ];
                break;
            case 'hy':
            default:
                articles = [
                    {
                        title: "11 փաստ, որոնք իմանալով հնարավոր չէ չսիրել Huawei-ը", text: "Սմարթֆոններ եւ այլ տեխնիկա ընտրելն այսօր հեշտ գործ չէ: Ընտրությունը մեծ է,  չափանիշները` տարբեր, ինչի հետեւանքով կարելի է խճճվել ու որակի փոխարեն ընտրել ընդամենը այն, ինչ ընտրում են մեր ծանոթները: Իսկ որակի չափանիշները հասկանալու համար պետք է ծանոթ լինել ոլորտի առաջատարներին:", date: '11.08.2016', img: '1.png', slug: '11_facts_about_huawei'
                    },
                    {
                        title: "7 համեմատություն, ինչից հետո դուք կցանկանաք ընտրել Huawei սմարթֆոն եւ ոչ թե Apple կամ Samsung:", text: "Սմարթֆոն ձեռք բերելիս բոլորս էլ փորձում ենք այն ընտրել ըստ մեր ունեցած գումարի չափի, ըստ տեխնիկայի մասին մեր պատկերացումների ու սկզբունքների: Առաջին հայացքից պարզ թվացող այս որոշումը, իրականում, միշտ չէ, որ հեշտ է: Ի՞նչ ընտրել, ինչպե՞ս ընտրել: Իրականում ցանկացած հարցում ճիշտ ընտրություն կատարելու հարցում օգնության է գալիս համեմատությունը: Ցանկանում եք կատարել ճի՞շտ ընտրություն: Համեմատելու եւ համեմատության միջոցով ընտրություն կատարելու համար եկեք ծանոթանանք այս 7 կետերին:", date: '24.08.2016', img: '7_reasons_to_choose_huawei/7facts.jpg', slug: '7_reasons_to_choose_huawei'
                    }
                ];
                break;
        }

        res.send(articles).end();
    });
    app.post('/api/getArticle',function (req, res) {
        var path = './data/blog/'+ req.body.lang + '-' + req.body.slug;
        fs.readFile(path + '.json', 'utf8', function (err, data) {
            if (err) {
                console.error(err);
                res.send({error : 'No such article.'});
            }
            else {
                var obj = JSON.parse(data);

                fs.readFile(path + '.html', 'utf8', function (err, data1) {
                    if (err) {
                        console.error(err);
                        res.send({error : 'No such article.'});
                    }
                    else {
                        obj.inner = data1;
                        res.send(obj);
                    }

                });
            }

        });
    });
    //app.post('*', function (req, res) {
    //    res.sendFile('index.html', { root: '././files/' });
    //});
    //app.get('*', function (req, res) {
    //    res.sendFile('index.html', { root: '././files/' });
    //});
    app.post('/sitemap.xml', function (req, res) {exports.generateSitemap(req, res)});

    app.get('/sitemap.xml', function (req, res) {exports.generateSitemap(req, res)});

    app.post('/robots.txt', function (req, res) {
        res.type('text/plain')
        res.send("User-agent: *\nDisallow: ");
    });

    app.get('/robots.txt', function (req, res) {
        res.type('text/plain')
        res.send("User-agent: *\nDisallow: ");
    });

    app.get('*', function (req, res) {
        var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
        //exports.botHack(req, res);
        if (userAgent.toLowerCase().indexOf("google") == -1 && userAgent != 'Googlebot' && userAgent != 'bingbot' && userAgent != 'Slurp' && userAgent.indexOf('Facebook') == -1 && userAgent.indexOf('facebookexternalhit/1.1') == -1 && userAgent != 'Facebot') {
            res.sendFile('index.html', { root: '././files/' });
        }
        else {
            exports.botHack(req, res);
        }
    });

    app.post('*', function (req, res) {
        var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
        //exports.botHack(req, res);
        if (userAgent.toLowerCase().indexOf("google") == -1 && userAgent != 'Googlebot' && userAgent != 'bingbot' && userAgent != 'Slurp' && userAgent.indexOf('Facebook') == -1 && userAgent.indexOf('facebookexternalhit/1.1') == -1 && userAgent != 'Facebot') {
            res.sendFile('index.html', { root: '././files/' });
        }
        else {
            exports.botHack(req, res);
        }
    });
};


exports.botHack = function (req, res) {
    var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
    var renderObject = {
        test : "test-dev"
    };
    try {
        if (req.url == '' || req.url == '/' || req.url == '/en/' || req.url == '/ru/' || req.url == '/hy/') {
            req.route.path = 'main';
        }
        else if (req.url.indexOf('smartphones') > -1) {
            req.route.path = 'smartphones';
        }
        else if (req.url.indexOf('tablets') > -1) {
            req.route.path = 'tablets';
        }
        else if (req.url.indexOf('blog') > -1) {
            if(req.url.split('blog/')[1]) {
                req.route.path = 'article';
                req.route.slug = req.url.split('blog/')[1];
            }
            else req.route.path = 'blog';
        }
        else if (req.url.indexOf('product') > -1) {
            req.route.path = 'product';
            req.route.slug = req.url.split('products/')[1];
        }
        else if (req.url.indexOf('enterprises') > -1) {
            req.route.path = 'enterprises';
        }
        else if (req.url.indexOf('aboutus') > -1) {
            req.route.path = 'aboutus';
        }
        else if (req.url.indexOf('about-us') > -1) {
            req.route.path = 'aboutus';
        }
        else if (req.url.indexOf('our-partners') > -1) {
            req.route.path = 'ourpartners';
        }
        else if (req.url.indexOf('contacts') > -1) {
            req.route.path = 'contacts';
        }
        else if (req.url.indexOf('termsofuse') > -1) {
        }
        else if (req.url.indexOf('privacy') > -1) {
        }
        else if (req.url.indexOf('signup') > -1) {
        }
        else if (req.url.indexOf('genre') > -1) {
        }
        else if (req.url.indexOf('article') > -1) {
            req.route.path = 'article';
        }
        else if (req.url.indexOf('robots') > -1) {
            req.route.path = 'robots';
        }
        else {
            req.route.path = 'main';
            console.log("bot / other");
        }
        var routeName = req.route.path.indexOf(':') === -1 ? req.route.path : req.route.path.substring(0, req.route.path.indexOf(":") - 1);
        exports.renderer(req, res, renderObject, routeName);
    }
    catch (e) {
        console.log({'level': 'ERROR', 'message': e});
    }
}

exports.generateSitemap = function(req, res) {
    var userAgent = uaParser.parse(req.headers['user-agent']).userAgent.family;
    var articleS = require('./articles.json');
    var productS = require('./products.json');
    var renderObject = {
        locales : ['hy','en','ru'],
        products : productS,
        articles : articleS,
        pages : ['smartphones', 'tablets', 'enterprises', 'blog', 'about-us', 'our-partners', 'contacts']
    };
    try {
        exports.renderer(req, res, renderObject, 'sitemap');
    }
    catch (e) {
        console.log({'level': 'ERROR', 'message': e});
    }
}

exports.renderer = function (req, res, rendererObject, from) {
    var hostname = req.headers.host.indexOf(':') === -1 ? req.headers.host : req.headers.host.substring(0, req.headers.host.indexOf(':'));
    try {
        var lang;
        if(req.url.slice(3,4)=="/") lang = req.url.slice(1,3); else lang='hy';
        var builderObject = {}, path, platformData = {}, lang_links=[];
        var metaInfo = require('./meta-info.json');
        var _social_links = [
            'https://vk.com/huaweidevicerus',
            'https://www.facebook.com/HuaweiDeviceRus',
            'https://twitter.com/huaweidevicerus',
            'http://www.youtube.com/user/HuaweiDeviceRus',
            'http://instagram.com/huaweidevicerussia'
        ];
        var _lang_links = [{
            href : 'http://' + req.hostname + '/en/' + req.url.slice(4),
            lang : 'en'
        }, {
            href : 'http://' + req.hostname + '/ru/' + req.url.slice(4),
            lang : 'ru'
        }, {
            href : 'http://' + req.hostname + '/hy/' + req.url.slice(4),
            lang : 'hy'
        }];
        switch (from) {
            case 'robots':
                builderObject.seo = {
                    hostname : hostname
                }
                path = 'robots';
                break;
            case 'sitemap':
                builderObject.seo = {
                   hostname : hostname,
                   locales : rendererObject.locales,
                   products :  rendererObject.products,
                   articles : rendererObject.articles,
                   pages : rendererObject.pages
                }
                path = 'sitemap';
                break;
            case 'main':
                builderObject.seo = {
                    title1: "",
                    title2: "Huawei Armenia | Official Site",
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/huawei-logo.jpg',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'smartphones':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/huawei-p9/1.jpg', 
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'tablets':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/mediapad-x1-7/1.jpg',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'blog':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/logo.png',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'enterprises':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/logo.png',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'aboutus':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/moblioslogo.jpg',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'ourpartners':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/moblioslogo.jpg',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'contacts':
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: metaInfo[from]["title"]["" + lang],
                    meta_description: metaInfo["main"]["descr"]["" + lang],
                    meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/moblioslogo.jpg',
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'main';
                break;
            case 'product':
                var productS = require('./products.json');
                var prod = productS[""+req.route.slug];
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: prod.title,
                    meta_description: prod.share_description["" + lang],
                    // meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/' + prod.slug + '/' + prod.share_img,
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'products';
                break;
            case 'article':
                var articleS = require('./articles.json');
                var article = articleS[""+req.route.slug];
                builderObject.seo = {
                    title1: "Huawei Armenia",
                    title2: article.title["" + lang],
                    meta_description: article.description["" + lang],
                    // meta_keywords: metaInfo[from]["keywords"]["" + lang],
                    url: 'http://' + req.hostname + '' + req.url,
                    img: 'http://' + req.hostname + '/img/blog/' + article.slug + '/' + article.img,
                    hostname: 'http://' + req.hostname + '',
                    lang_links: _lang_links,
                    social_links: _social_links
                }
                path = 'products';
                break;
        }
        if ('robots' == path) {
            res.type('text/plain')
            res.send("User-agent: *\nDisallow: /");
        } else {
            res.render('' + path + '.html', {data: builderObject}, function (error, html) {
                if (!error) {
                    res.end(html);
                    //res.end();
                    return;
                }
                else {
                    console.error("renderer error : " + error);
                }
                return;
            });
        }
    }
    catch (e) {
        console.log(e);
    }
}
